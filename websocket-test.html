<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket åˆ†å¸ƒå¼ç¯å¢ƒæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .ping-button {
            background: #28a745;
            font-size: 16px;
            padding: 15px 30px;
        }
        .ping-button:hover {
            background: #218838;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        .ping-section {
            text-align: center;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 5px;
        }
        .message-item {
            padding: 8px;
            margin: 2px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .message-broadcast {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
        }
        .message-echo {
            background: #f0f9ff;
            border-left: 4px solid #17a2b8;
        }
        .message-system {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .instance-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        .user-badge {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        /* æ–°å¢æ ·å¼ */
        .notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .notification-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid;
            animation: slideInRight 0.3s ease-out;
            position: relative;
        }
        
        .notification-item.drill-start {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
        }
        
        .notification-item.system {
            border-left-color: #007bff;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
        }
        
        .notification-item.task {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #fff 100%);
        }
        
        .notification-item.event {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffdf8 0%, #fff 100%);
        }
        
        .notification-item.echo {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #f8fdff 0%, #fff 100%);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .notification-time {
            font-size: 11px;
            color: #666;
        }
        
        .notification-content {
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }
        
        .notification-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .meta-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .meta-user {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .meta-instance {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .meta-action {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .close-btn {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #999;
            padding: 0;
            margin: 0;
        }
        
        .close-btn:hover {
            color: #666;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .notification-item.fade-out {
            animation: fadeOut 0.5s ease-in forwards;
        }
        
        .auto-dismiss {
            position: relative;
            overflow: hidden;
        }
        
        .auto-dismiss::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(to right, #007bff, #28a745);
            animation: progressBar 5s linear forwards;
        }
        
        @keyframes progressBar {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        .message-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .toggle-notifications {
            position: fixed;
            top: 20px;
            right: 380px;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <h1>WebSocket åˆ†å¸ƒå¼ç¯å¢ƒæµ‹è¯•å·¥å…·</h1>
    
    <div class="container">
        <div class="section">
            <h3>åˆ†å¸ƒå¼WebSocketè¿æ¥æµ‹è¯•</h3>
            <div class="flex-container">
                <div class="flex-item">
                    <label>ç”¨æˆ·æ ‡è¯† (User):</label>
                    <input type="text" id="userId" value="user001" placeholder="è¾“å…¥ç”¨æˆ·ID">
                    
                    <label>WebSocketè¿æ¥åœ°å€:</label>
                    <input type="text" id="wsUrl" value="ws://127.0.0.1:8080/ws" placeholder="è‡ªåŠ¨éšæœºé€‰æ‹©å®ä¾‹" readonly style="background-color: #f8f9fa;">
                    <button onclick="refreshWsUrl()" style="margin-top: 5px;">ğŸ”„ éšæœºé€‰æ‹©å®ä¾‹</button>
                    
                    <div id="wsStatus" class="status disconnected">æœªè¿æ¥</div>
                    <button id="connectBtn" onclick="connectWebSocket()">è¿æ¥WebSocket</button>
                    <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>æ–­å¼€è¿æ¥</button>
                </div>
                <div class="flex-item">
                    <label>å‘é€æ¶ˆæ¯:</label>
                    <input type="text" id="messageInput" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯">
                    <button onclick="sendMessage()" id="sendBtn" disabled>å‘é€æ¶ˆæ¯</button>
                    
                    <div style="margin-top: 10px;">
                        <button onclick="reconnectWithNewUser()" id="reconnectBtn">åˆ‡æ¢ç”¨æˆ·é‡è¿</button>
                    </div>
                </div>
            </div>
            <div class="log" id="wsLog"></div>
        </div>
    </div>

    <div class="container">
        <div class="ping-section">
            <h3>åˆ†å¸ƒå¼å¹¿æ’­æµ‹è¯•</h3>
            <p>æµ‹è¯•é€šè¿‡è´Ÿè½½å‡è¡¡è®¿é—®ä¸åŒå®ä¾‹ï¼Œç„¶åRediså¹¿æ’­åˆ°æ‰€æœ‰å®ä¾‹çš„WebSocketè¿æ¥</p>
            
            <div class="flex-container">
                <div class="flex-item">
                    <button onclick="pingWebSocket()" class="ping-button">ğŸ“ å‘é€Pingå¹¿æ’­</button>
                    <p style="font-size: 12px; color: #666;">
                        ç‚¹å‡»æ­¤æŒ‰é’®ä¼šè‡ªåŠ¨éšæœºè®¿é—®ä¸€ä¸ªå®ä¾‹çš„APIï¼Œ<br>
                        è¯¥å®ä¾‹ä¼šé€šè¿‡Rediså¹¿æ’­æ¶ˆæ¯åˆ°æ‰€æœ‰å®ä¾‹çš„WebSocketè¿æ¥
                    </p>
                </div>
                <div class="flex-item">
                    <label>æµ‹è¯•ç”¨æˆ·åˆ—è¡¨ (æ¨¡æ‹Ÿå¤šç”¨æˆ·):</label>
                    <div id="userButtons">
                        <button onclick="connectAsUser('user001')" style="margin: 2px;">ç”¨æˆ·001</button>
                        <button onclick="connectAsUser('user002')" style="margin: 2px;">ç”¨æˆ·002</button>
                        <button onclick="connectAsUser('user003')" style="margin: 2px;">ç”¨æˆ·003</button>
                        <button onclick="connectAsUser('admin')" style="margin: 2px;">ç®¡ç†å‘˜</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <label>å®ä¾‹åœ°å€é…ç½®:</label>
                <input type="text" id="serverUrls" value="http://127.0.0.1:8080,http://127.0.0.1:8081,http://127.0.0.1:8082"
                       placeholder="å¤šä¸ªåœ°å€ç”¨é€—å·åˆ†éš”" style="width: 100%;">
                <p style="font-size: 12px; color: #666;">
                    é…ç½®å¤šä¸ªå®ä¾‹åœ°å€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨éšæœºé€‰æ‹©ã€‚å½“å‰è¯·æ±‚å°†å‘é€åˆ°: <span id="currentTarget" style="font-weight: bold; color: #007bff;">éšæœºé€‰æ‹©</span>
                </p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æµ‹è¯•æ­¥éª¤è¯´æ˜</h3>
            <ol style="color: #666; font-size: 14px;">
                <li><strong>è¿æ¥WebSocket:</strong> é€‰æ‹©ä¸€ä¸ªç”¨æˆ·èº«ä»½ï¼Œè¿æ¥åˆ°è´Ÿè½½å‡è¡¡åœ°å€</li>
                <li><strong>å¤šç”¨æˆ·æµ‹è¯•:</strong> æ‰“å¼€å¤šä¸ªæµè§ˆå™¨æ ‡ç­¾é¡µï¼Œåˆ†åˆ«ä»¥ä¸åŒç”¨æˆ·èº«ä»½è¿æ¥</li>
                <li><strong>å‘é€å¹¿æ’­:</strong> ç‚¹å‡»"å‘é€Pingå¹¿æ’­"æŒ‰é’®ï¼Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ªå®ä¾‹å‘é€APIè¯·æ±‚</li>
                <li><strong>è§‚å¯Ÿç»“æœ:</strong> æ‰€æœ‰è¿æ¥çš„WebSocketéƒ½åº”è¯¥æ”¶åˆ°å¹¿æ’­æ¶ˆæ¯ï¼Œæ— è®ºè¿æ¥åˆ°å“ªä¸ªå®ä¾‹</li>
                <li><strong>åˆ‡æ¢æµ‹è¯•:</strong> æ–­å¼€é‡è¿åˆ°ä¸åŒå®ä¾‹ï¼ŒéªŒè¯Rediså¹¿æ’­æœºåˆ¶</li>
            </ol>
        </div>
    </div>

    <!-- æ–°å¢é€šçŸ¥åˆ‡æ¢æŒ‰é’® -->
    <button class="toggle-notifications" onclick="toggleNotifications()">
        <span id="notificationToggleText">ğŸ”” æ˜¾ç¤ºé€šçŸ¥</span>
    </button>
    
    <!-- æ–°å¢é€šçŸ¥åŒºåŸŸ -->
    <div class="notification-area" id="notificationArea" style="display: none;">
        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
            <h4 style="margin: 0; color: #333;">å®æ—¶æ¶ˆæ¯æ¨é€</h4>
            <button onclick="clearNotifications()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-top: 5px;">æ¸…ç©ºé€šçŸ¥</button>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>æ¶ˆæ¯ç»Ÿè®¡</h3>
            <div class="message-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number" id="totalMessages">0</span>
                        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="broadcastMessages">0</span>
                        <div class="stat-label">å¹¿æ’­æ¶ˆæ¯</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="echoMessages">0</span>
                        <div class="stat-label">å›åº”æ¶ˆæ¯</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="systemMessages">0</span>
                        <div class="stat-label">ç³»ç»Ÿæ¶ˆæ¯</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let isConnected = false;
        let currentUser = 'user001';

        // æ–°å¢å˜é‡å®šä¹‰
        let wsInstances = ['ws://127.0.0.1:8080/ws', 'ws://127.0.0.1:8081/ws', 'ws://127.0.0.1:8082/ws'];
        let httpInstances = ['http://127.0.0.1:8080', 'http://127.0.0.1:8081', 'http://127.0.0.1:8082'];
        let messageStats = {
            total: 0,
            broadcast: 0,
            echo: 0,
            system: 0
        };
        let notificationsVisible = false;
        let maxNotifications = 10; // æœ€å¤šæ˜¾ç¤º10æ¡é€šçŸ¥

        function log(elementId, message, messageType = 'system') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item message-${messageType}`;
            messageDiv.innerHTML = `[${timestamp}] ${message}`;
            
            logElement.appendChild(messageDiv);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateWSStatus(connected) {
            const statusElement = document.getElementById('wsStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendBtn = document.getElementById('sendBtn');
            const reconnectBtn = document.getElementById('reconnectBtn');
            
            isConnected = connected;
            
            if (connected) {
                statusElement.textContent = `å·²è¿æ¥ (${currentUser})`;
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                reconnectBtn.disabled = false;
            } else {
                statusElement.textContent = 'æœªè¿æ¥';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                reconnectBtn.disabled = true;
            }
        }

        function formatMessageWithInstanceInfo(data) {
            let message = '';
            
            if (data.fromUser && data.fromInstance) {
                message += `<span class="user-badge">${data.fromUser}</span>`;
                message += `<span class="instance-badge">å®ä¾‹:${data.fromInstance}</span> `;
            }
            
            if (data.action) {
                message += `åŠ¨ä½œ: ${data.action} `;
            }
            
            if (data.data) {
                message += `æ•°æ®: ${JSON.stringify(data.data)}`;
            }
            
            if (data.type) {
                message += `ç±»å‹: ${data.type} `;
            }
            
            if (data.message) {
                message += `å†…å®¹: ${data.message}`;
            }
            
            return message;
        }

        function getRandomWsUrl() {
            const randomIndex = Math.floor(Math.random() * wsInstances.length);
            return wsInstances[randomIndex];
        }

        function getRandomServerUrl() {
            const serverUrls = document.getElementById('serverUrls').value.split(',').map(url => url.trim());
            const randomIndex = Math.floor(Math.random() * serverUrls.length);
            const selectedUrl = serverUrls[randomIndex];
            
            // æ›´æ–°å½“å‰ç›®æ ‡æ˜¾ç¤º
            document.getElementById('currentTarget').textContent = selectedUrl;
            return selectedUrl;
        }

        function refreshWsUrl() {
            const newUrl = getRandomWsUrl();
            document.getElementById('wsUrl').value = newUrl;
            log('wsLog', `ğŸ² éšæœºé€‰æ‹©WebSocketå®ä¾‹: ${newUrl}`, 'system');
        }

        function connectWebSocket() {
            const url = document.getElementById('wsUrl').value;
            currentUser = document.getElementById('userId').value;
            
            if (!currentUser) {
                log('wsLog', 'âŒ è¯·è¾“å…¥ç”¨æˆ·æ ‡è¯†');
                return;
            }
            
            // å…ˆæ–­å¼€ç°æœ‰è¿æ¥
            if (websocket) {
                websocket.close();
            }
            
            try {
                // å°†userä¿¡æ¯æ”¾åœ¨URLå‚æ•°ä¸­
                const urlWithUser = `${url}?user=${encodeURIComponent(currentUser)}`;
                log('wsLog', `ğŸ”— å°è¯•è¿æ¥: ${urlWithUser}`, 'system');
                
                websocket = new WebSocket(urlWithUser);
                
                websocket.onopen = function(event) {
                    log('wsLog', `âœ… WebSocket è¿æ¥æˆåŠŸï¼Œç”¨æˆ·: ${currentUser}`, 'system');
                    log('wsLog', `ğŸ”— è¿æ¥å®ä¾‹: ${url}`, 'system');
                    updateWSStatus(true);
                };
                
                websocket.onmessage = function(event) {
                    log('wsLog', `ğŸ“¨ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${event.data}`, 'system');
                    
                    try {
                        const msgData = JSON.parse(event.data);
                        
                        // æ ¹æ®æ¶ˆæ¯ç±»å‹é€‰æ‹©ä¸åŒçš„æ ·å¼
                        let messageType = 'system';
                        if (msgData.action === 'DRILL_START') {
                            messageType = 'broadcast';
                        } else if (msgData.type === 'echo' || msgData.type === 'pong' || msgData.type === 'welcome') {
                            messageType = 'echo';
                        }
                        
                        // æ›´æ–°ç»Ÿè®¡
                        updateMessageStats(messageType);
                        
                        // åˆ›å»ºé€šçŸ¥
                        if (notificationsVisible) {
                            createNotification(msgData, messageType);
                        }
                        
                        const formattedMessage = formatMessageWithInstanceInfo(msgData);
                        log('wsLog', `ğŸ“¨ ${formattedMessage}`, messageType);
                        
                    } catch (e) {
                        // ä¸æ˜¯JSONæ ¼å¼çš„æ¶ˆæ¯
                        updateMessageStats('system');
                        log('wsLog', `ğŸ“¨ éJSONæ¶ˆæ¯: ${event.data}`, 'system');
                    }
                };
                
                websocket.onclose = function(event) {
                    log('wsLog', `âŒ WebSocket è¿æ¥å…³é—­ (ä»£ç : ${event.code}, åŸå› : ${event.reason})`, 'system');
                    updateWSStatus(false);
                };
                
                websocket.onerror = function(event) {
                    log('wsLog', `âŒ WebSocket è¿æ¥é”™è¯¯: ${JSON.stringify(event)}`, 'system');
                    updateWSStatus(false);
                };
                
            } catch (error) {
                log('wsLog', `âŒ è¿æ¥å¤±è´¥: ${error.message}ï¼Œå°è¯•é‡æ–°é€‰æ‹©å®ä¾‹`, 'system');
                // è¿æ¥å¤±è´¥æ—¶è‡ªåŠ¨é€‰æ‹©æ–°å®ä¾‹
                setTimeout(() => {
                    refreshWsUrl();
                }, 1000);
            }
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (websocket && isConnected && message) {
                log('wsLog', `ğŸ“¤ å‘é€æ¶ˆæ¯: ${message}`, 'system');
                websocket.send(message);
                document.getElementById('messageInput').value = '';
            } else {
                log('wsLog', 'âŒ æ— æ³•å‘é€æ¶ˆæ¯ï¼Œè¯·æ£€æŸ¥è¿æ¥çŠ¶æ€', 'system');
            }
        }

        function connectAsUser(userId) {
            disconnectWebSocket();
            document.getElementById('userId').value = userId;
            // åˆ‡æ¢ç”¨æˆ·æ—¶ä¹Ÿéšæœºé€‰æ‹©æ–°å®ä¾‹
            refreshWsUrl();
            setTimeout(() => {
                connectWebSocket();
            }, 500);
        }

        function reconnectWithNewUser() {
            const newUser = prompt("è¯·è¾“å…¥æ–°çš„ç”¨æˆ·ID:", currentUser);
            if (newUser && newUser !== currentUser) {
                disconnectWebSocket();
                document.getElementById('userId').value = newUser;
                setTimeout(() => {
                    connectWebSocket();
                }, 500);
            }
        }

        // ä¿®å¤asyncå‡½æ•°å®šä¹‰
        async function pingWebSocket() {
            const serverUrl = getRandomServerUrl();
            
            try {
                log('wsLog', `ğŸ“ å‘é€Pingè¯·æ±‚åˆ°: ${serverUrl}`, 'system');
                
                const response = await fetch(`${serverUrl}/test/json/websocket/ping`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    log('wsLog', `âœ… Pingè¯·æ±‚æˆåŠŸå‘é€åˆ° ${serverUrl}ï¼Œç­‰å¾…Rediså¹¿æ’­...`, 'system');
                    log('wsLog', 'ğŸ‘€ è§‚å¯Ÿå³ä¾§é€šçŸ¥é¢æ¿ï¼ŒæŸ¥çœ‹å¹¿æ’­æ¶ˆæ¯', 'system');
                } else {
                    log('wsLog', `âŒ Pingè¯·æ±‚å¤±è´¥: ${response.status} (${serverUrl})`, 'system');
                    // å¤±è´¥æ—¶å°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹
                    setTimeout(() => {
                        log('wsLog', 'ğŸ”„ å°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹...', 'system');
                        pingWebSocket();
                    }, 1000);
                }
            } catch (error) {
                log('wsLog', `âŒ Pingè¯·æ±‚é”™è¯¯: ${error.message} (${serverUrl})`, 'system');
                // ç½‘ç»œé”™è¯¯æ—¶ä¹Ÿå°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹
                setTimeout(() => {
                    log('wsLog', 'ğŸ”„ å°è¯•ä¸‹ä¸€ä¸ªå®ä¾‹...', 'system');
                    pingWebSocket();
                }, 1000);
            }
        }

        function testWebSocketConnection() {
            if (websocket && isConnected) {
                log('wsLog', 'ğŸ”§ æµ‹è¯•WebSocketè¿æ¥...', 'system');
                websocket.send('ping');
            } else {
                log('wsLog', 'âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•æµ‹è¯•', 'system');
            }
        }

        function toggleNotifications() {
            const area = document.getElementById('notificationArea');
            const toggleText = document.getElementById('notificationToggleText');
            
            notificationsVisible = !notificationsVisible;
            
            if (notificationsVisible) {
                area.style.display = 'block';
                toggleText.textContent = 'ğŸ”• éšè—é€šçŸ¥';
            } else {
                area.style.display = 'none';
                toggleText.textContent = 'ğŸ”” æ˜¾ç¤ºé€šçŸ¥';
            }
        }

        function clearNotifications() {
            const area = document.getElementById('notificationArea');
            const notifications = area.querySelectorAll('.notification-item');
            notifications.forEach(item => item.remove());
        }

        function updateMessageStats(messageType) {
            messageStats.total++;
            
            switch(messageType) {
                case 'broadcast':
                    messageStats.broadcast++;
                    break;
                case 'echo':
                    messageStats.echo++;
                    break;
                case 'system':
                    messageStats.system++;
                    break;
            }
            
            // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
            document.getElementById('totalMessages').textContent = messageStats.total;
            document.getElementById('broadcastMessages').textContent = messageStats.broadcast;
            document.getElementById('echoMessages').textContent = messageStats.echo;
            document.getElementById('systemMessages').textContent = messageStats.system;
        }

        function createNotification(data, messageType) {
            const area = document.getElementById('notificationArea');
            
            // é™åˆ¶é€šçŸ¥æ•°é‡
            const existingNotifications = area.querySelectorAll('.notification-item');
            if (existingNotifications.length >= maxNotifications) {
                existingNotifications[existingNotifications.length - 1].remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification-item auto-dismiss ${getNotificationClass(data, messageType)}`;
            
            const title = getNotificationTitle(data, messageType);
            const content = getNotificationContent(data);
            const time = new Date().toLocaleTimeString();
            
            notification.innerHTML = `
                <button class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
                <div class="notification-header">
                    <div class="notification-title">${title}</div>
                    <div class="notification-time">${time}</div>
                </div>
                <div class="notification-content">${content}</div>
                <div class="notification-meta">
                    ${data.fromUser ? `<span class="meta-badge meta-user">ğŸ‘¤ ${data.fromUser}</span>` : ''}
                    ${data.fromInstance ? `<span class="meta-badge meta-instance">ğŸ–¥ï¸ å®ä¾‹:${data.fromInstance}</span>` : ''}
                    ${data.action ? `<span class="meta-badge meta-action">âš¡ ${data.action}</span>` : ''}
                </div>
            `;
            
            // æ’å…¥åˆ°é¡¶éƒ¨
            const header = area.firstElementChild;
            area.insertBefore(notification, header.nextSibling);
            
            // æ ¹æ®æ¶ˆæ¯ç±»å‹è®¾ç½®ä¸åŒçš„æ¶ˆå¤±æ—¶é—´
            let dismissTime = 5000; // é»˜è®¤5ç§’
            if (data.action && data.action.includes('DRILL')) {
                dismissTime = 8000; // æ¼”ç»ƒæ¶ˆæ¯8ç§’
            } else if (data.type === 'welcome' || data.type === 'pong') {
                dismissTime = 3000; // ç³»ç»Ÿæ¶ˆæ¯3ç§’
            }
            
            // è‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 500); // ç­‰å¾…åŠ¨ç”»å®Œæˆ
                }
            }, dismissTime);
        }

        function getNotificationClass(data, messageType) {
            if (data.action && data.action.includes('DRILL')) return 'drill-start';
            if (data.action && data.action.includes('TASK')) return 'task';
            if (data.action && data.action.includes('EVENT')) return 'event';
            if (messageType === 'echo') return 'echo';
            return 'system';
        }

        function getNotificationTitle(data, messageType) {
            if (data.action) {
                const actionTitles = {
                    'DRILL_START': 'ğŸš¨ æ¼”ç»ƒå¼€å§‹',
                    'SYSTEM_NOTIFICATION': 'ğŸ“¢ ç³»ç»Ÿé€šçŸ¥',
                    'TASK_ASSIGNED': 'ğŸ“‹ ä»»åŠ¡åˆ†é…',
                    'TASK_UPDATED': 'ğŸ“ ä»»åŠ¡æ›´æ–°',
                    'NEW_EVENT': 'ğŸ†• æ–°äº‹ä»¶',
                    'USER_ONLINE': 'ğŸ‘‹ ç”¨æˆ·ä¸Šçº¿',
                    'HeartBeat': 'ğŸ’“ å¿ƒè·³æ£€æµ‹'
                };
                return actionTitles[data.action] || `âš¡ ${data.action}`;
            }
            
            if (data.type === 'welcome') return 'ğŸ‰ æ¬¢è¿è¿æ¥';
            if (data.type === 'pong') return 'ğŸ“ è¿æ¥æµ‹è¯•';
            if (data.type === 'echo') return 'ğŸ”„ æ¶ˆæ¯å›æ˜¾';
            
            return 'ğŸ“¨ æ–°æ¶ˆæ¯';
        }

        function getNotificationContent(data) {
            if (data.message) return data.message;
            if (data.data && typeof data.data === 'object') {
                return JSON.stringify(data.data, null, 2);
            }
            if (data.data) return data.data;
            return 'æ”¶åˆ°æ–°çš„WebSocketæ¶ˆæ¯';
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('wsLog', 'ğŸš€ åˆ†å¸ƒå¼WebSocketæµ‹è¯•å·¥å…·å·²åŠ è½½', 'system');
            log('wsLog', 'ğŸ’¡ ç³»ç»Ÿå°†è‡ªåŠ¨é€‰æ‹©å¯ç”¨å®ä¾‹è¿›è¡Œè¿æ¥', 'system');
            
            // åˆå§‹åŒ–éšæœºé€‰æ‹©å®ä¾‹
            refreshWsUrl();
            
            // é»˜è®¤å¼€å¯é€šçŸ¥
            setTimeout(() => {
                toggleNotifications();
            }, 2000);
            
            // è‡ªåŠ¨è¿æ¥æµ‹è¯•
            setTimeout(() => {
                log('wsLog', 'ğŸ”„ è‡ªåŠ¨å°è¯•è¿æ¥WebSocket...', 'system');
                connectWebSocket();
            }, 3000);
            
            // æ·»åŠ æµ‹è¯•æŒ‰é’®åˆ°pingåŒºåŸŸ
            const pingSection = document.querySelector('.ping-section .flex-container .flex-item');
            if (pingSection) {
                const testBtn = document.createElement('button');
                testBtn.textContent = 'ğŸ”§ æµ‹è¯•WebSocketè¿æ¥';
                testBtn.onclick = testWebSocketConnection;
                testBtn.style.margin = '5px';
                pingSection.appendChild(testBtn);
            }
            
            // å›è½¦é”®å‘é€æ¶ˆæ¯
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
</script>
</body>
</html>
