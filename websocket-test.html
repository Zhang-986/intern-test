<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket ÂàÜÂ∏ÉÂºèÁéØÂ¢ÉÊµãËØï</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .ping-button {
            background: #28a745;
            font-size: 16px;
            padding: 15px 30px;
        }
        .ping-button:hover {
            background: #218838;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .log {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px 0;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        .ping-section {
            text-align: center;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 20px;
            border-radius: 5px;
        }
        .message-item {
            padding: 8px;
            margin: 2px 0;
            border-radius: 4px;
            font-size: 12px;
        }
        .message-broadcast {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
        }
        .message-echo {
            background: #f0f9ff;
            border-left: 4px solid #17a2b8;
        }
        .message-system {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .instance-badge {
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        .user-badge {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 5px;
        }
        
        /* Êñ∞Â¢ûÊ†∑Âºè */
        .notification-area {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .notification-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-left: 4px solid;
            animation: slideInRight 0.3s ease-out;
            position: relative;
        }
        
        .notification-item.drill-start {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
        }
        
        .notification-item.system {
            border-left-color: #007bff;
            background: linear-gradient(135deg, #f8f9ff 0%, #fff 100%);
        }
        
        .notification-item.task {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f8fff8 0%, #fff 100%);
        }
        
        .notification-item.event {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffdf8 0%, #fff 100%);
        }
        
        .notification-item.echo {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #f8fdff 0%, #fff 100%);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 14px;
            color: #333;
        }
        
        .notification-time {
            font-size: 11px;
            color: #666;
        }
        
        .notification-content {
            font-size: 13px;
            color: #555;
            margin-bottom: 8px;
        }
        
        .notification-meta {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .meta-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .meta-user {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .meta-instance {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .meta-action {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .close-btn {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #999;
            padding: 0;
            margin: 0;
        }
        
        .close-btn:hover {
            color: #666;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        
        .notification-item.fade-out {
            animation: fadeOut 0.5s ease-in forwards;
        }
        
        .auto-dismiss {
            position: relative;
            overflow: hidden;
        }
        
        .auto-dismiss::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(to right, #007bff, #28a745);
            animation: progressBar 5s linear forwards;
        }
        
        @keyframes progressBar {
            from {
                width: 100%;
            }
            to {
                width: 0%;
            }
        }
        
        .message-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .toggle-notifications {
            position: fixed;
            top: 20px;
            right: 380px;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <h1>WebSocket ÂàÜÂ∏ÉÂºèÁéØÂ¢ÉÊµãËØïÂ∑•ÂÖ∑</h1>
    
    <div class="container">
        <div class="section">
            <h3>ÂàÜÂ∏ÉÂºèWebSocketËøûÊé•ÊµãËØï</h3>
            <div class="flex-container">
                <div class="flex-item">
                    <label>Áî®Êà∑Ê†áËØÜ (User):</label>
                    <input type="text" id="userId" value="user001" placeholder="ËæìÂÖ•Áî®Êà∑ID">
                    
                    <label>WebSocketËøûÊé•Âú∞ÂùÄ:</label>
                    <input type="text" id="wsUrl" value="ws://127.0.0.1:8080/ws" placeholder="Ëá™Âä®ÈöèÊú∫ÈÄâÊã©ÂÆû‰æã" readonly style="background-color: #f8f9fa;">
                    <button onclick="refreshWsUrl()" style="margin-top: 5px;">üîÑ ÈöèÊú∫ÈÄâÊã©ÂÆû‰æã</button>
                    
                    <div id="wsStatus" class="status disconnected">Êú™ËøûÊé•</div>
                    <button id="connectBtn" onclick="connectWebSocket()">ËøûÊé•WebSocket</button>
                    <button id="disconnectBtn" onclick="disconnectWebSocket()" disabled>Êñ≠ÂºÄËøûÊé•</button>
                </div>
                <div class="flex-item">
                    <label>ÂèëÈÄÅÊ∂àÊÅØ:</label>
                    <input type="text" id="messageInput" placeholder="ËæìÂÖ•Ë¶ÅÂèëÈÄÅÁöÑÊ∂àÊÅØ">
                    <button onclick="sendMessage()" id="sendBtn" disabled>ÂèëÈÄÅÊ∂àÊÅØ</button>
                    
                    <div style="margin-top: 10px;">
                        <button onclick="reconnectWithNewUser()" id="reconnectBtn">ÂàáÊç¢Áî®Êà∑ÈáçËøû</button>
                    </div>
                </div>
            </div>
            <div class="log" id="wsLog"></div>
        </div>
    </div>

    <div class="container">
        <div class="ping-section">
            <h3>ÂàÜÂ∏ÉÂºèÂπøÊí≠ÊµãËØï</h3>
            <p>ÊµãËØïÈÄöËøáË¥üËΩΩÂùáË°°ËÆøÈóÆ‰∏çÂêåÂÆû‰æãÔºåÁÑ∂ÂêéRedisÂπøÊí≠Âà∞ÊâÄÊúâÂÆû‰æãÁöÑWebSocketËøûÊé•</p>
            
            <div class="flex-container">
                <div class="flex-item">
                    <button onclick="pingWebSocket()" class="ping-button">üèì ÂèëÈÄÅPingÂπøÊí≠</button>
                    <p style="font-size: 12px; color: #666;">
                        ÁÇπÂáªÊ≠§ÊåâÈíÆ‰ºöËá™Âä®ÈöèÊú∫ËÆøÈóÆ‰∏Ä‰∏™ÂÆû‰æãÁöÑAPIÔºå<br>
                        ËØ•ÂÆû‰æã‰ºöÈÄöËøáRedisÂπøÊí≠Ê∂àÊÅØÂà∞ÊâÄÊúâÂÆû‰æãÁöÑWebSocketËøûÊé•
                    </p>
                </div>
                <div class="flex-item">
                    <label>ÊµãËØïÁî®Êà∑ÂàóË°® (Ê®°ÊãüÂ§öÁî®Êà∑):</label>
                    <div id="userButtons">
                        <button onclick="connectAsUser('user001')" style="margin: 2px;">Áî®Êà∑001</button>
                        <button onclick="connectAsUser('user002')" style="margin: 2px;">Áî®Êà∑002</button>
                        <button onclick="connectAsUser('user003')" style="margin: 2px;">Áî®Êà∑003</button>
                        <button onclick="connectAsUser('admin')" style="margin: 2px;">ÁÆ°ÁêÜÂëò</button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <label>ÂÆû‰æãÂú∞ÂùÄÈÖçÁΩÆ:</label>
                <input type="text" id="serverUrls" value="http://127.0.0.1:8080,http://127.0.0.1:8081,http://127.0.0.1:8082"
                       placeholder="Â§ö‰∏™Âú∞ÂùÄÁî®ÈÄóÂè∑ÂàÜÈöî" style="width: 100%;">
                <p style="font-size: 12px; color: #666;">
                    ÈÖçÁΩÆÂ§ö‰∏™ÂÆû‰æãÂú∞ÂùÄÔºåÁ≥ªÁªü‰ºöËá™Âä®ÈöèÊú∫ÈÄâÊã©„ÄÇÂΩìÂâçËØ∑Ê±ÇÂ∞ÜÂèëÈÄÅÂà∞: <span id="currentTarget" style="font-weight: bold; color: #007bff;">ÈöèÊú∫ÈÄâÊã©</span>
                </p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>ÊµãËØïÊ≠•È™§ËØ¥Êòé</h3>
            <ol style="color: #666; font-size: 14px;">
                <li><strong>ËøûÊé•WebSocket:</strong> ÈÄâÊã©‰∏Ä‰∏™Áî®Êà∑Ë∫´‰ªΩÔºåËøûÊé•Âà∞Ë¥üËΩΩÂùáË°°Âú∞ÂùÄ</li>
                <li><strong>Â§öÁî®Êà∑ÊµãËØï:</strong> ÊâìÂºÄÂ§ö‰∏™ÊµèËßàÂô®Ê†áÁ≠æÈ°µÔºåÂàÜÂà´‰ª•‰∏çÂêåÁî®Êà∑Ë∫´‰ªΩËøûÊé•</li>
                <li><strong>ÂèëÈÄÅÂπøÊí≠:</strong> ÁÇπÂáª"ÂèëÈÄÅPingÂπøÊí≠"ÊåâÈíÆÔºå‰ºöÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÂÆû‰æãÂèëÈÄÅAPIËØ∑Ê±Ç</li>
                <li><strong>ËßÇÂØüÁªìÊûú:</strong> ÊâÄÊúâËøûÊé•ÁöÑWebSocketÈÉΩÂ∫îËØ•Êî∂Âà∞ÂπøÊí≠Ê∂àÊÅØÔºåÊó†ËÆ∫ËøûÊé•Âà∞Âì™‰∏™ÂÆû‰æã</li>
                <li><strong>ÂàáÊç¢ÊµãËØï:</strong> Êñ≠ÂºÄÈáçËøûÂà∞‰∏çÂêåÂÆû‰æãÔºåÈ™åËØÅRedisÂπøÊí≠Êú∫Âà∂</li>
            </ol>
        </div>
    </div>

    <!-- Êñ∞Â¢ûÈÄöÁü•ÂàáÊç¢ÊåâÈíÆ -->
    <button class="toggle-notifications" onclick="toggleNotifications()">
        <span id="notificationToggleText">üîî ÊòæÁ§∫ÈÄöÁü•</span>
    </button>
    
    <!-- Êñ∞Â¢ûÈÄöÁü•Âå∫Âüü -->
    <div class="notification-area" id="notificationArea" style="display: none;">
        <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; text-align: center;">
            <h4 style="margin: 0; color: #333;">ÂÆûÊó∂Ê∂àÊÅØÊé®ÈÄÅ</h4>
            <button onclick="clearNotifications()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; margin-top: 5px;">Ê∏ÖÁ©∫ÈÄöÁü•</button>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h3>Ê∂àÊÅØÁªüËÆ°</h3>
            <div class="message-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-number" id="totalMessages">0</span>
                        <div class="stat-label">ÊÄªÊ∂àÊÅØÊï∞</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="broadcastMessages">0</span>
                        <div class="stat-label">ÂπøÊí≠Ê∂àÊÅØ</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="echoMessages">0</span>
                        <div class="stat-label">ÂõûÂ∫îÊ∂àÊÅØ</div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="systemMessages">0</span>
                        <div class="stat-label">Á≥ªÁªüÊ∂àÊÅØ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let websocket = null;
        let isConnected = false;
        let currentUser = 'user001';

        // Êñ∞Â¢ûÂèòÈáèÂÆö‰πâ
        let wsInstances = ['ws://127.0.0.1:8080/ws', 'ws://127.0.0.1:8081/ws', 'ws://127.0.0.1:8082/ws'];
        let httpInstances = ['http://127.0.0.1:8080', 'http://127.0.0.1:8081', 'http://127.0.0.1:8082'];
        let messageStats = {
            total: 0,
            broadcast: 0,
            echo: 0,
            system: 0
        };
        let notificationsVisible = false;
        let maxNotifications = 10; // ÊúÄÂ§öÊòæÁ§∫10Êù°ÈÄöÁü•

        function log(elementId, message, messageType = 'system') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-item message-${messageType}`;
            messageDiv.innerHTML = `[${timestamp}] ${message}`;
            
            logElement.appendChild(messageDiv);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function updateWSStatus(connected) {
            const statusElement = document.getElementById('wsStatus');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const sendBtn = document.getElementById('sendBtn');
            const reconnectBtn = document.getElementById('reconnectBtn');
            
            isConnected = connected;
            
            if (connected) {
                statusElement.textContent = `Â∑≤ËøûÊé• (${currentUser})`;
                statusElement.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                sendBtn.disabled = false;
                reconnectBtn.disabled = false;
            } else {
                statusElement.textContent = 'Êú™ËøûÊé•';
                statusElement.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                sendBtn.disabled = true;
                reconnectBtn.disabled = true;
            }
        }

        function formatMessageWithInstanceInfo(data) {
            let message = '';
            
            if (data.fromUser && data.fromInstance) {
                message += `<span class="user-badge">${data.fromUser}</span>`;
                message += `<span class="instance-badge">ÂÆû‰æã:${data.fromInstance}</span> `;
            }
            
            if (data.action) {
                message += `Âä®‰Ωú: ${data.action} `;
            }
            
            if (data.data) {
                message += `Êï∞ÊçÆ: ${JSON.stringify(data.data)}`;
            }
            
            if (data.type) {
                message += `Á±ªÂûã: ${data.type} `;
            }
            
            if (data.message) {
                message += `ÂÜÖÂÆπ: ${data.message}`;
            }
            
            return message;
        }

        function getRandomWsUrl() {
            const randomIndex = Math.floor(Math.random() * wsInstances.length);
            return wsInstances[randomIndex];
        }

        function getRandomServerUrl() {
            const serverUrls = document.getElementById('serverUrls').value.split(',').map(url => url.trim());
            const randomIndex = Math.floor(Math.random() * serverUrls.length);
            const selectedUrl = serverUrls[randomIndex];
            
            // Êõ¥Êñ∞ÂΩìÂâçÁõÆÊ†áÊòæÁ§∫
            document.getElementById('currentTarget').textContent = selectedUrl;
            return selectedUrl;
        }

        function refreshWsUrl() {
            const newUrl = getRandomWsUrl();
            document.getElementById('wsUrl').value = newUrl;
            log('wsLog', `üé≤ ÈöèÊú∫ÈÄâÊã©WebSocketÂÆû‰æã: ${newUrl}`, 'system');
        }

        function connectWebSocket() {
            const url = document.getElementById('wsUrl').value;
            currentUser = document.getElementById('userId').value;
            
            if (!currentUser) {
                log('wsLog', '‚ùå ËØ∑ËæìÂÖ•Áî®Êà∑Ê†áËØÜ');
                return;
            }
            
            // ÂÖàÊñ≠ÂºÄÁé∞ÊúâËøûÊé•
            if (websocket) {
                websocket.close();
            }
            
            try {
                // Â∞Üuser‰ø°ÊÅØÊîæÂú®URLÂèÇÊï∞‰∏≠
                const urlWithUser = `${url}?user=${encodeURIComponent(currentUser)}`;
                log('wsLog', `üîó Â∞ùËØïËøûÊé•: ${urlWithUser}`, 'system');
                
                websocket = new WebSocket(urlWithUser);
                
                websocket.onopen = function(event) {
                    log('wsLog', `‚úÖ WebSocket ËøûÊé•ÊàêÂäüÔºåÁî®Êà∑: ${currentUser}`, 'system');
                    log('wsLog', `üîó ËøûÊé•ÂÆû‰æã: ${url}`, 'system');
                    updateWSStatus(true);
                };
                
                websocket.onmessage = function(event) {
                    log('wsLog', `üì® Êî∂Âà∞ÂéüÂßãÊ∂àÊÅØ: ${event.data}`, 'system');
                    
                    try {
                        const msgData = JSON.parse(event.data);
                        
                        // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÈÄâÊã©‰∏çÂêåÁöÑÊ†∑Âºè
                        let messageType = 'system';
                        if (msgData.action === 'DRILL_START') {
                            messageType = 'broadcast';
                        } else if (msgData.type === 'echo' || msgData.type === 'pong' || msgData.type === 'welcome') {
                            messageType = 'echo';
                        }
                        
                        // Êõ¥Êñ∞ÁªüËÆ°
                        updateMessageStats(messageType);
                        
                        // ÂàõÂª∫ÈÄöÁü•
                        if (notificationsVisible) {
                            createNotification(msgData, messageType);
                        }
                        
                        const formattedMessage = formatMessageWithInstanceInfo(msgData);
                        log('wsLog', `üì® ${formattedMessage}`, messageType);
                        
                    } catch (e) {
                        // ‰∏çÊòØJSONÊ†ºÂºèÁöÑÊ∂àÊÅØ
                        updateMessageStats('system');
                        log('wsLog', `üì® ÈùûJSONÊ∂àÊÅØ: ${event.data}`, 'system');
                    }
                };
                
                websocket.onclose = function(event) {
                    log('wsLog', `‚ùå WebSocket ËøûÊé•ÂÖ≥Èó≠ (‰ª£Á†Å: ${event.code}, ÂéüÂõ†: ${event.reason})`, 'system');
                    updateWSStatus(false);
                };
                
                websocket.onerror = function(event) {
                    log('wsLog', `‚ùå WebSocket ËøûÊé•ÈîôËØØ: ${JSON.stringify(event)}`, 'system');
                    updateWSStatus(false);
                };
                
            } catch (error) {
                log('wsLog', `‚ùå ËøûÊé•Â§±Ë¥•: ${error.message}ÔºåÂ∞ùËØïÈáçÊñ∞ÈÄâÊã©ÂÆû‰æã`, 'system');
                // ËøûÊé•Â§±Ë¥•Êó∂Ëá™Âä®ÈÄâÊã©Êñ∞ÂÆû‰æã
                setTimeout(() => {
                    refreshWsUrl();
                }, 1000);
            }
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        function sendMessage() {
            const message = document.getElementById('messageInput').value;
            if (websocket && isConnected && message) {
                log('wsLog', `üì§ ÂèëÈÄÅÊ∂àÊÅØ: ${message}`, 'system');
                websocket.send(message);
                document.getElementById('messageInput').value = '';
            } else {
                log('wsLog', '‚ùå Êó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØÔºåËØ∑Ê£ÄÊü•ËøûÊé•Áä∂ÊÄÅ', 'system');
            }
        }

        function connectAsUser(userId) {
            disconnectWebSocket();
            document.getElementById('userId').value = userId;
            // ÂàáÊç¢Áî®Êà∑Êó∂‰πüÈöèÊú∫ÈÄâÊã©Êñ∞ÂÆû‰æã
            refreshWsUrl();
            setTimeout(() => {
                connectWebSocket();
            }, 500);
        }

        function reconnectWithNewUser() {
            const newUser = prompt("ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁî®Êà∑ID:", currentUser);
            if (newUser && newUser !== currentUser) {
                disconnectWebSocket();
                document.getElementById('userId').value = newUser;
                setTimeout(() => {
                    connectWebSocket();
                }, 500);
            }
        }

        // ‰øÆÂ§çasyncÂáΩÊï∞ÂÆö‰πâ
        async function pingWebSocket() {
            const serverUrl = getRandomServerUrl();
            
            try {
                log('wsLog', `üèì ÂèëÈÄÅPingËØ∑Ê±ÇÂà∞: ${serverUrl}`, 'system');
                
                const response = await fetch(`${serverUrl}/test/json/websocket/ping`, {
                    method: 'GET'
                });
                
                if (response.ok) {
                    log('wsLog', `‚úÖ PingËØ∑Ê±ÇÊàêÂäüÂèëÈÄÅÂà∞ ${serverUrl}ÔºåÁ≠âÂæÖRedisÂπøÊí≠...`, 'system');
                    log('wsLog', 'üëÄ ËßÇÂØüÂè≥‰æßÈÄöÁü•Èù¢ÊùøÔºåÊü•ÁúãÂπøÊí≠Ê∂àÊÅØ', 'system');
                } else {
                    log('wsLog', `‚ùå PingËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} (${serverUrl})`, 'system');
                    // Â§±Ë¥•Êó∂Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂÆû‰æã
                    setTimeout(() => {
                        log('wsLog', 'üîÑ Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂÆû‰æã...', 'system');
                        pingWebSocket();
                    }, 1000);
                }
            } catch (error) {
                log('wsLog', `‚ùå PingËØ∑Ê±ÇÈîôËØØ: ${error.message} (${serverUrl})`, 'system');
                // ÁΩëÁªúÈîôËØØÊó∂‰πüÂ∞ùËØï‰∏ã‰∏Ä‰∏™ÂÆû‰æã
                setTimeout(() => {
                    log('wsLog', 'üîÑ Â∞ùËØï‰∏ã‰∏Ä‰∏™ÂÆû‰æã...', 'system');
                    pingWebSocket();
                }, 1000);
            }
        }

        function testWebSocketConnection() {
            if (websocket && isConnected) {
                log('wsLog', 'üîß ÊµãËØïWebSocketËøûÊé•...', 'system');
                websocket.send('ping');
            } else {
                log('wsLog', '‚ùå WebSocketÊú™ËøûÊé•ÔºåÊó†Ê≥ïÊµãËØï', 'system');
            }
        }

        function toggleNotifications() {
            const area = document.getElementById('notificationArea');
            const toggleText = document.getElementById('notificationToggleText');
            
            notificationsVisible = !notificationsVisible;
            
            if (notificationsVisible) {
                area.style.display = 'block';
                toggleText.textContent = 'üîï ÈöêËóèÈÄöÁü•';
            } else {
                area.style.display = 'none';
                toggleText.textContent = 'üîî ÊòæÁ§∫ÈÄöÁü•';
            }
        }

        function clearNotifications() {
            const area = document.getElementById('notificationArea');
            const notifications = area.querySelectorAll('.notification-item');
            notifications.forEach(item => item.remove());
        }

        function updateMessageStats(messageType) {
            messageStats.total++;
            
            switch(messageType) {
                case 'broadcast':
                    messageStats.broadcast++;
                    break;
                case 'echo':
                    messageStats.echo++;
                    break;
                case 'system':
                    messageStats.system++;
                    break;
            }
            
            // Êõ¥Êñ∞ÁªüËÆ°ÊòæÁ§∫
            document.getElementById('totalMessages').textContent = messageStats.total;
            document.getElementById('broadcastMessages').textContent = messageStats.broadcast;
            document.getElementById('echoMessages').textContent = messageStats.echo;
            document.getElementById('systemMessages').textContent = messageStats.system;
        }

        function createNotification(data, messageType) {
            const area = document.getElementById('notificationArea');
            
            // ÈôêÂà∂ÈÄöÁü•Êï∞Èáè
            const existingNotifications = area.querySelectorAll('.notification-item');
            if (existingNotifications.length >= maxNotifications) {
                existingNotifications[existingNotifications.length - 1].remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification-item auto-dismiss ${getNotificationClass(data, messageType)}`;
            
            const title = getNotificationTitle(data, messageType);
            const content = getNotificationContent(data);
            const time = new Date().toLocaleTimeString();
            
            notification.innerHTML = `
                <button class="close-btn" onclick="this.parentElement.remove()">√ó</button>
                <div class="notification-header">
                    <div class="notification-title">${title}</div>
                    <div class="notification-time">${time}</div>
                </div>
                <div class="notification-content">${content}</div>
                <div class="notification-meta">
                    ${data.fromUser ? `<span class="meta-badge meta-user">üë§ ${data.fromUser}</span>` : ''}
                    ${data.fromInstance ? `<span class="meta-badge meta-instance">üñ•Ô∏è ÂÆû‰æã:${data.fromInstance}</span>` : ''}
                    ${data.action ? `<span class="meta-badge meta-action">‚ö° ${data.action}</span>` : ''}
                </div>
            `;
            
            // ÊèíÂÖ•Âà∞È°∂ÈÉ®
            const header = area.firstElementChild;
            area.insertBefore(notification, header.nextSibling);
            
            // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãËÆæÁΩÆ‰∏çÂêåÁöÑÊ∂àÂ§±Êó∂Èó¥
            let dismissTime = 5000; // ÈªòËÆ§5Áßí
            if (data.action && data.action.includes('DRILL')) {
                dismissTime = 8000; // ÊºîÁªÉÊ∂àÊÅØ8Áßí
            } else if (data.type === 'welcome' || data.type === 'pong') {
                dismissTime = 3000; // Á≥ªÁªüÊ∂àÊÅØ3Áßí
            }
            
            // Ëá™Âä®Ê∂àÂ§±
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 500); // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
                }
            }, dismissTime);
        }

        function getNotificationClass(data, messageType) {
            if (data.action && data.action.includes('DRILL')) return 'drill-start';
            if (data.action && data.action.includes('TASK')) return 'task';
            if (data.action && data.action.includes('EVENT')) return 'event';
            if (messageType === 'echo') return 'echo';
            return 'system';
        }

        function getNotificationTitle(data, messageType) {
            if (data.action) {
                const actionTitles = {
                    'DRILL_START': 'üö® ÊºîÁªÉÂºÄÂßã',
                    'SYSTEM_NOTIFICATION': 'üì¢ Á≥ªÁªüÈÄöÁü•',
                    'TASK_ASSIGNED': 'üìã ‰ªªÂä°ÂàÜÈÖç',
                    'TASK_UPDATED': 'üìù ‰ªªÂä°Êõ¥Êñ∞',
                    'NEW_EVENT': 'üÜï Êñ∞‰∫ã‰ª∂',
                    'USER_ONLINE': 'üëã Áî®Êà∑‰∏äÁ∫ø',
                    'HeartBeat': 'üíì ÂøÉË∑≥Ê£ÄÊµã'
                };
                return actionTitles[data.action] || `‚ö° ${data.action}`;
            }
            
            if (data.type === 'welcome') return 'üéâ Ê¨¢ËøéËøûÊé•';
            if (data.type === 'pong') return 'üèì ËøûÊé•ÊµãËØï';
            if (data.type === 'echo') return 'üîÑ Ê∂àÊÅØÂõûÊòæ';
            
            return 'üì® Êñ∞Ê∂àÊÅØ';
        }

        function getNotificationContent(data) {
            if (data.message) return data.message;
            if (data.data && typeof data.data === 'object') {
                return JSON.stringify(data.data, null, 2);
            }
            if (data.data) return data.data;
            return 'Êî∂Âà∞Êñ∞ÁöÑWebSocketÊ∂àÊÅØ';
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            log('wsLog', 'üöÄ ÂàÜÂ∏ÉÂºèWebSocketÊµãËØïÂ∑•ÂÖ∑Â∑≤Âä†ËΩΩ', 'system');
            log('wsLog', 'üí° Á≥ªÁªüÂ∞ÜËá™Âä®ÈÄâÊã©ÂèØÁî®ÂÆû‰æãËøõË°åËøûÊé•', 'system');
            
            // ÂàùÂßãÂåñÈöèÊú∫ÈÄâÊã©ÂÆû‰æã
            refreshWsUrl();
            
            // ÈªòËÆ§ÂºÄÂêØÈÄöÁü•
            setTimeout(() => {
                toggleNotifications();
            }, 2000);
            
            // Ëá™Âä®ËøûÊé•ÊµãËØï
            setTimeout(() => {
                log('wsLog', 'üîÑ Ëá™Âä®Â∞ùËØïËøûÊé•WebSocket...', 'system');
                connectWebSocket();
            }, 3000);
            
            // Ê∑ªÂä†ÊµãËØïÊåâÈíÆÂà∞pingÂå∫Âüü
            const pingSection = document.querySelector('.ping-section .flex-container .flex-item');
            if (pingSection) {
                const testBtn = document.createElement('button');
                testBtn.textContent = 'üîß ÊµãËØïWebSocketËøûÊé•';
                testBtn.onclick = testWebSocketConnection;
                testBtn.style.margin = '5px';
                pingSection.appendChild(testBtn);
            }
            
            // ÂõûËΩ¶ÈîÆÂèëÈÄÅÊ∂àÊÅØ
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
</script>
</body>
</html>
